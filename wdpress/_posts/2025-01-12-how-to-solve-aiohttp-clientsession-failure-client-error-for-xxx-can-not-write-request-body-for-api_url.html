---
layout: post
title: 'How to solve aiohttp.ClientSession failure: Client error for XXX: Can not
  write request body for API_URL'
date: 2025-01-12 14:40:22.000000000 +08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- aiohttp.ClientSession issue
- API
- fastapi
- programming
- technology
meta:
  _last_editor_used_jetpack: block-editor
  firehose_sent: '1736664023'
  timeline_notification: '1736664024'
  _publicize_job_id: '100868484405'
  _elasticsearch_data_sharing_indexed_on: '2025-01-12 06:39:27'
  _publicize_done_external: a:1:{s:8:"facebook";a:1:{i:26861408;s:53:"https://facebook.com/1630088060609695_625772403312260";}}
  _publicize_shares: a:9:{s:6:"status";s:7:"success";s:7:"message";s:53:"https://facebook.com/1630088060609695_625772403312260";s:9:"timestamp";i:1736664030;s:7:"service";s:8:"facebook";s:13:"connection_id";i:23923317;s:11:"external_id";s:16:"1630088060609695";s:13:"external_name";s:2:"Sw";s:15:"profile_picture";s:341:"https://scontent-lax3-1.xx.fbcdn.net/v/t1.30497-1/453178253_471506465671661_2781666950760530985_n.png?stp=cp0_dst-png_s50x50&_nc_cat=110&ccb=1-7&_nc_sid=22ec41&_nc_ohc=UB459iPQgKoQ7kNvgH4B0oI&_nc_zt=24&_nc_ht=scontent-lax3-1.xx&edm=AGaHXAAEAAAA&_nc_gid=A8k5GfB6_RC0m_3eDbxpvfS&oh=00_AYBUFbBN78b80-DLpHfme4pN4C_zDskzoIXO43Zh9uWpYA&oe=67A8A57A";s:12:"profile_link";s:41:"https://www.facebook.com/1630088060609695";}
  _publicize_done_23923317: '1'
  _wpas_done_26861408: '1'
  reader_suggested_tags: '["Technology","API","Programming","Rest","Cloud"]'
  login: c013a2015
  email: c013a2015@gmail.com
  display_name: sheng gao
  first_name: sheng
  last_name: gao
permalink: "/2025/01/12/how-to-solve-aiohttp-clientsession-failure-client-error-for-xxx-can-not-write-request-body-for-api_url/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p><strong>aiohttp_ClientSession_issue</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Investigate aiohttp.ClientSession randomly failure when batch calling APIs, e.g. Client error for XXX: Can not write request body for API_URL</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>What is the issue?</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The issue happends when you call your API endpoint (e.g. FastAPI server) from server side using batch. Normally we use asynchronous + semaphore + aiohttp to control traffic sent to server. Sometimes, it works fine. Sometime server return nothing, and the client catch errors, e.g. Client error for XXX: Can not write request body for server_url, e.g. http://0.0.0.0:port/...</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Googling cannot find the reason what causes the issue. After reading the aiohttp.ClientSession source code, I guess the issue maybe caused by Timeout setting when calling ClientSession. Almost all use default setting. But default Timeout, total = 300 seconds. It maybe enough for adhoc usage. But for production, e.g. your server need to call OpenAPI API to do reasoning and process, only 1 openai API call may spending a few seconds (e.g. 6s, or even more &gt; 10s in multi-modality &amp; long response, e.g 2K output token).</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The issue looks randomly. You cannot repeat.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The project is to test whether the issue is caused by Timeout and how configure parameters affect failure rate</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Test Experiments</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Test parameters:</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>- Argument in asyncio.Semaphore</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>- Argument (total = xxx) in aiohttp.ClientTimeout</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>- Work number</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>- Start server: Uvicorn or Gunicorn</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":2462,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{site.baseurl}}/assets/2025/01/image.png?w=1024" alt="" class="wp-image-2462"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Practical setting</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>In general, increase Timeout(total=XX) can reduce failure. In aiohttp ClientSession instance initialize the default `timeout = sentinel`, which means `DEFAULT_TIMEOUT: Final[ClientTimeout] = ClientTimeout(total=5 * 60)`, i.e. default 300 seconds.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Estimate total setting in timeout</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>total &gt;= seconds_of_API_call (average or max) * #_of_request_async_task / (#_of_worker  #_of_Semaphore (parallel call))

e.g. in the demo

seconds_of_API_call = 1s
#_of_Semaphore = 2
#_of_worker = 2
#_of_request_async = 10

total &gt;= (1*10) / (2 * 2) = 2.5</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph --></p>
<p>Hope this analysis can help you solve the API call failure issue.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Code and detail analysis on the affect of parameter setting on API call success and failure rate in <a href="https://github.com/aigaosheng/aiohttp_ClientSession_issue.git">Github: aiohttp_ClientSession_issue</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
