---
layout: post
title: 'DuckDB: an efficient SQL development in Python'
date: 2025-01-19 12:32:11.000000000 +08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- database
- duckdb
- postgres
- PostgreSQL
- sql
meta:
  _last_editor_used_jetpack: block-editor
  firehose_sent: '1737261133'
  timeline_notification: '1737261134'
  _publicize_job_id: '101043978667'
  _elasticsearch_data_sharing_indexed_on: '2025-01-19 04:32:01'
  _publicize_done_external: a:1:{s:8:"facebook";a:1:{i:26861408;s:53:"https://facebook.com/1630088060609695_630546746168159";}}
  _publicize_shares: a:9:{s:6:"status";s:7:"success";s:7:"message";s:53:"https://facebook.com/1630088060609695_630546746168159";s:9:"timestamp";i:1737261142;s:7:"service";s:8:"facebook";s:13:"connection_id";i:23923317;s:11:"external_id";s:16:"1630088060609695";s:13:"external_name";s:2:"Sw";s:15:"profile_picture";s:341:"https://scontent-lax3-1.xx.fbcdn.net/v/t1.30497-1/453178253_471506465671661_2781666950760530985_n.png?stp=cp0_dst-png_s50x50&_nc_cat=110&ccb=1-7&_nc_sid=22ec41&_nc_ohc=UB459iPQgKoQ7kNvgH4B0oI&_nc_zt=24&_nc_ht=scontent-lax3-1.xx&edm=AGaHXAAEAAAA&_nc_gid=A8k5GfB6_RC0m_3eDbxpvfS&oh=00_AYBUFbBN78b80-DLpHfme4pN4C_zDskzoIXO43Zh9uWpYA&oe=67A8A57A";s:12:"profile_link";s:41:"https://www.facebook.com/1630088060609695";}
  _publicize_done_23923317: '1'
  _wpas_done_26861408: '1'
  login: c013a2015
  email: c013a2015@gmail.com
  display_name: sheng gao
  first_name: sheng
  last_name: gao
permalink: "/2025/01/19/duckdb-an-efficient-sql-development-in-python/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p>After a few weeks using <a href="https://github.com/duckdb/duckdb">DuckDb</a> to develop product, particularly to handle complex data processing logic (e.g. multiple table join, condition, group, expand, cross-database operation, ...), I like it more and more. Before that I use psycopg2 to connect database and download to Pandas, then use Pandas to do data processing, and finally write processed data to database table. For simple data processing logic, it is easy. But when need doing complex processing logic and join tables from different database and database servers, it is becoming tedious and inefficient using Pandas. I would like a tool that can reduce the pain.  That is DuckDB I find it.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>DuckDB  is quite similar to my previous Database dev environment DataWork of AliCloud. DuckDB is Python friendly. So I use it to develop my user profiling product, which is heavily data logic processing such as join, pivot, expand, group on many tables and cross database server. Besides sufficient  inner functions, you can also self-define Python function, register, and use it in DuckDB SQL. It is quite amazing. Here I will show a few tips on connect to Postgres server, create table, and insert table examples.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Install </h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>pip install duckdb</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Connect to Postgres database</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>```con_local``` is the variable what you use to access hereafter</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code># install postgres adaptor
duckdb.sql("INSTALL postgres; LOAD postgres;")

# Set your Database secrets, create for each database connector using different secret_name. You set can ready only or write/read allowed

_secret_template = """
CREATE SECRET IF NOT EXISTS {secret_name} (
            TYPE POSTGRES,
            HOST '{host}',
            PORT {port},
            DATABASE {database},
            USER '{username}',
            PASSWORD '{password}'
        );
 ATTACH IF NOT EXISTS '' AS {conn_alias} (TYPE POSTGRES, SECRET {secret_name}, SCHEMA 'public', READ_ONLY);
        """

 _secret_template_wr = """CREATE SECRET IF NOT EXISTS {secret_name} (
            TYPE POSTGRES,
            HOST '{host}',
            PORT {port},
            DATABASE {database},
            USER '{username}',
            PASSWORD '{password}'
        );
 ATTACH IF NOT EXISTS '' AS {conn_alias} (TYPE POSTGRES, SECRET {secret_name}, SCHEMA 'public');
        """
 duckdb.sql(self._secret_template_wr.format(
            username = "postgres",
            password = "postgres",
            host = "localhost",
            port = 5432,
            database = "postgres",
            secret_name = "secret_local",
            conn_alias = "con_local",
            )
        )</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Access the table in database</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code># Read table
# e.f. if a table, named user_accounts, in postgres database. Columns e.g. user_id, name, location

sql_str = """ SELECT user_id, name, location FROM con_local.user_accounts;"""
data = duckdb.sql(sql_str)

#write table
sql_str = """ INSERT INTO con_local.user_accounts
SELECT user_id, name, location FROM (VALUES (1,'a','a1'))
"""
data = duckdb.sql(sql_str)
</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Register a function</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>The following shows an example case of how to define custom function and call it in SQL to process user content.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>def word_split(msg) -&gt; str:
        words = set(map(lambda x: x.strip("-*[]\n"), msg.split(" ")))

        return ",".join(words)

duckdb.create_function("my_word_split", word_split, [VARCHAR], VARCHAR)

data = duckdb.sql("""
SELECT user_id,user_message
       my_word_split(user_message) AS word_list,
       created_at,
       current_date as updated_at
FROM con_local.user_content
""")
</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph --></p>
<p>More detailed tutorial refer DuckDB official document.</p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
